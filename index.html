<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mersal Bull | Premium 3D Animation</title>
    <style>
        :root {
            --primary: #ff3e00;
            --secondary: #ffb400;
            --bg: #0a0a0a;
            --glass: rgba(20, 20, 20, 0.85);
        }

        *,
        *::before,
        *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body,
        html {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: var(--bg);
            color: #fff;
            font-family: 'Outfit', -apple-system, sans-serif;
        }

        #scene-container {
            width: 100%;
            height: 100%;
            position: relative;
        }

        /* â”€â”€ VIGNETTE â”€â”€ */
        .vignette {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 5;
            background: radial-gradient(circle, transparent 45%, rgba(0, 0, 0, .85) 160%);
        }

        /* â”€â”€ FLASH OVERLAY â”€â”€ */
        #flash {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 200;
            background: #ff3e00;
            opacity: 0;
            transition: opacity 0.05s;
        }

        /* â”€â”€ SCREEN SHAKE â”€â”€ */
        @keyframes shake {

            0%,
            100% {
                transform: translate(0, 0) rotate(0deg);
            }

            10% {
                transform: translate(-6px, 4px) rotate(-0.5deg);
            }

            20% {
                transform: translate(6px, -4px) rotate(0.5deg);
            }

            30% {
                transform: translate(-5px, 5px) rotate(-0.3deg);
            }

            40% {
                transform: translate(5px, -3px) rotate(0.3deg);
            }

            50% {
                transform: translate(-4px, 4px) rotate(-0.2deg);
            }

            60% {
                transform: translate(4px, -4px) rotate(0.2deg);
            }

            70% {
                transform: translate(-3px, 3px) rotate(-0.1deg);
            }

            80% {
                transform: translate(3px, -2px) rotate(0.1deg);
            }

            90% {
                transform: translate(-2px, 2px) rotate(0deg);
            }
        }

        .shaking {
            animation: shake 0.6s ease-in-out;
        }

        /* â”€â”€ HUD â”€â”€ */
        .hud {
            position: absolute;
            inset: 0;
            z-index: 100;
            pointer-events: none;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .title-group {
            border-left: 4px solid var(--primary);
            padding-left: 1.2rem;
        }

        h1 {
            font-size: 2.4rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 2px;
            background: linear-gradient(45deg, #fff, var(--secondary));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .subtitle {
            font-size: .8rem;
            color: var(--secondary);
            font-weight: 600;
            letter-spacing: 4px;
            text-transform: uppercase;
            margin-top: .2rem;
        }

        /* â”€â”€ STATUS BADGE â”€â”€ */
        #status-badge {
            display: inline-flex;
            align-items: center;
            gap: .5rem;
            background: var(--glass);
            border: 1px solid rgba(255, 255, 255, .1);
            backdrop-filter: blur(12px);
            border-radius: 30px;
            padding: .5rem 1.2rem;
            font-size: .8rem;
            font-weight: 600;
            letter-spacing: 1px;
            text-transform: uppercase;
            transition: all .3s ease;
        }

        #status-badge .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4caf50;
            box-shadow: 0 0 8px #4caf50;
            animation: pulse-dot 1.5s ease-in-out infinite;
        }

        @keyframes pulse-dot {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: .3;
            }
        }

        #status-badge.charging {
            background: rgba(255, 62, 0, .3);
            border-color: var(--primary);
        }

        #status-badge.charging .dot {
            background: var(--primary);
            box-shadow: 0 0 12px var(--primary);
        }

        /* â”€â”€ FOOTER â”€â”€ */
        .footer {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            gap: 1rem;
        }

        /* â”€â”€ BUTTON PANEL â”€â”€ */
        .btn-panel {
            pointer-events: all;
            display: flex;
            gap: .8rem;
            flex-wrap: wrap;
        }

        .btn {
            background: var(--glass);
            border: 1px solid rgba(255, 255, 255, .15);
            color: #fff;
            padding: .75rem 1.4rem;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 700;
            font-size: .8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all .25s cubic-bezier(.4, 0, .2, 1);
            display: flex;
            align-items: center;
            gap: .5rem;
            backdrop-filter: blur(10px);
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 24px rgba(255, 62, 0, .3);
            background: var(--primary);
            border-color: var(--primary);
        }

        .btn.active {
            background: var(--primary);
            border-color: var(--primary);
            box-shadow: 0 0 20px rgba(255, 62, 0, .5);
        }

        /* CHARGE BUTTON special */
        #charge-btn {
            background: linear-gradient(135deg, #ff3e00, #ff8c00);
            border-color: #ff8c00;
            font-size: .9rem;
            padding: .85rem 1.8rem;
            box-shadow: 0 0 20px rgba(255, 62, 0, .4);
            animation: charge-pulse 2s ease-in-out infinite;
        }

        @keyframes charge-pulse {

            0%,
            100% {
                box-shadow: 0 0 20px rgba(255, 62, 0, .4);
            }

            50% {
                box-shadow: 0 0 40px rgba(255, 62, 0, .8), 0 0 60px rgba(255, 140, 0, .3);
            }
        }

        #charge-btn:hover {
            transform: scale(1.05) translateY(-3px);
        }

        #charge-btn:disabled {
            opacity: .5;
            cursor: not-allowed;
            transform: none;
            animation: none;
        }

        /* KICK BUTTON special */
        #kick-btn {
            background: linear-gradient(135deg, #7b00ff, #c800ff);
            border-color: #c800ff;
            font-size: .9rem;
            padding: .85rem 1.8rem;
            box-shadow: 0 0 20px rgba(123, 0, 255, .4);
            animation: kick-pulse 2s ease-in-out infinite;
        }

        @keyframes kick-pulse {

            0%,
            100% {
                box-shadow: 0 0 20px rgba(123, 0, 255, .4);
            }

            50% {
                box-shadow: 0 0 40px rgba(123, 0, 255, .8), 0 0 60px rgba(200, 0, 255, .3);
            }
        }

        #kick-btn:hover {
            transform: scale(1.05) translateY(-3px);
        }

        #kick-btn:disabled {
            opacity: .5;
            cursor: not-allowed;
            transform: none;
            animation: none;
        }

        /* â”€â”€ CONTROLS HINT â”€â”€ */
        .controls-hint {
            background: var(--glass);
            padding: .9rem 1.3rem;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, .08);
            font-size: .75rem;
            color: #777;
            line-height: 1.7;
        }

        .controls-hint strong {
            color: var(--secondary);
            display: block;
            margin-bottom: .2rem;
        }

        /* â”€â”€ LOADER â”€â”€ */
        .loader-overlay {
            position: absolute;
            inset: 0;
            background: var(--bg);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: opacity .8s ease;
        }

        .loader-spinner {
            width: 56px;
            height: 56px;
            border: 4px solid rgba(255, 62, 0, .1);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1.5rem;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .progress-bar {
            width: 200px;
            height: 2px;
            background: rgba(255, 255, 255, .1);
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            width: 0%;
            height: 100%;
            background: var(--primary);
            transition: width .3s ease;
        }

        .hidden {
            opacity: 0 !important;
            pointer-events: none !important;
        }

        /* â”€â”€ CHARGE LABEL â”€â”€ */
        #charge-label {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 5rem;
            font-weight: 800;
            text-transform: uppercase;
            color: var(--primary);
            letter-spacing: 8px;
            text-shadow: 0 0 40px rgba(255, 62, 0, .8);
            opacity: 0;
            pointer-events: none;
            z-index: 300;
            transition: opacity .2s;
        }

        /* â”€â”€ KICK LABEL â”€â”€ */
        #kick-label {
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 5rem;
            font-weight: 800;
            text-transform: uppercase;
            color: #c800ff;
            letter-spacing: 8px;
            text-shadow: 0 0 40px rgba(200, 0, 255, .9), 0 0 80px rgba(123, 0, 255, .5);
            opacity: 0;
            pointer-events: none;
            z-index: 300;
            transition: opacity .15s;
        }

        /* â”€â”€ LEG KICK VISUAL (CSS hoof trails) â”€â”€ */
        .hoof-trail {
            position: absolute;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: radial-gradient(circle, #c800ff, transparent);
            pointer-events: none;
            z-index: 250;
            animation: hoof-fade .5s ease-out forwards;
        }

        @keyframes hoof-fade {
            from {
                opacity: .9;
                transform: scale(1);
            }

            to {
                opacity: 0;
                transform: scale(3);
            }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
</head>

<body>
    <div id="scene-container">
        <div class="vignette"></div>
        <div id="flash"></div>
        <div id="charge-label">âš¡ CHARGE!</div>
        <div id="kick-label">ğŸ’¥ KICK!</div>

        <div class="hud">
            <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                <div class="title-group">
                    <h1>Mersal Bull</h1>
                    <div class="subtitle">Jallikattu Heritage Simulator</div>
                </div>
                <div id="status-badge"><span class="dot"></span><span id="status-text">IDLE</span></div>
            </div>

            <div class="footer">
                <div class="btn-panel" id="anim-panel">
                    <button class="btn" id="charge-btn" onclick="triggerCharge()">
                        ğŸ‚ CHARGE!
                    </button>
                    <button class="btn" id="kick-btn" onclick="triggerKick()">
                        ğŸ¦µ BACK KICK!
                    </button>
                    <!-- GLB animation buttons injected here -->
                </div>
                <div class="controls-hint">
                    <strong>VIEWER CONTROLS</strong>
                    Rotate: Left Click + Drag<br>
                    Zoom: Scroll Wheel<br>
                    Pan: Right Click + Drag
                </div>
            </div>
        </div>

        <div class="loader-overlay" id="loader">
            <div class="loader-spinner"></div>
            <div style="color:#666;font-size:.8rem;letter-spacing:2px;text-transform:uppercase;margin-bottom:.5rem;">
                Preparing the Arena</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <div id="loader-text" style="margin-top:1rem;color:var(--secondary);font-weight:600;">Loading Bull...</div>
        </div>
    </div>

    <script type="importmap">
{
    "imports": {
        "three": "https://unpkg.com/three@0.161.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.161.0/examples/jsm/"
    }
}
</script>
    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           GLOBALS
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        let scene, camera, renderer, controls, clock;
        let mixer, bullModel;
        let dustSystem, groundRumble;
        const glbAnims = new Map();

        // Charge state machine
        let chargeState = 'idle'; // idle | windup | sprint | brake | reset
        let chargeT = 0;
        let chargeDir = new THREE.Vector3(0, 0, -1);
        let bullStartPos, bullTargetPos;
        let originalCamPos, originalCamTarget;
        let shakeIntensity = 0;

        // â”€â”€ KICK state machine â”€â”€
        let kickState = 'idle'; // idle | lean | lift | snap | recoil | settle
        let kickT = 0;
        // Leg bone proxies (invisible objects we animate, then read world pos for dust/FX)
        let legBoneL, legBoneR;   // back-left / back-right upper
        let hoofBoneL, hoofBoneR; // hoof tips
        let kickStartRotX = 0;    // bull body rotation at kick start

        // Dust particles
        let dustPositions, dustVelocities, dustLifetimes, dustGeo, dustMesh;
        const DUST_COUNT = 300;

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           INIT
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        init();

        async function init() {
            clock = new THREE.Clock();

            // Scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0a0a0a);
            scene.fog = new THREE.FogExp2(0x0a0a0a, 0.04);

            // Camera
            camera = new THREE.PerspectiveCamera(42, innerWidth / innerHeight, 0.1, 500);
            camera.position.set(0, 2.5, 9);
            originalCamPos = camera.position.clone();
            originalCamTarget = new THREE.Vector3(0, 1.5, 0);

            // Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(innerWidth, innerHeight);
            renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMappingExposure = 1.1;
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            document.getElementById('scene-container').appendChild(renderer.domElement);

            // Orbit controls
            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.06;
            controls.target.copy(originalCamTarget);
            controls.maxDistance = 25;
            controls.minDistance = 2;

            setupLights();
            setupEnvironment();
            setupDust();
            loadBull();

            window.addEventListener('resize', () => {
                camera.aspect = innerWidth / innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(innerWidth, innerHeight);
            });

            animate();
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           LIGHTS
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        function setupLights() {
            scene.add(new THREE.AmbientLight(0xffffff, 0.25));

            const sun = new THREE.DirectionalLight(0xfff5e0, 2.5);
            sun.position.set(8, 18, 10);
            sun.castShadow = true;
            sun.shadow.mapSize.set(2048, 2048);
            sun.shadow.camera.left = sun.shadow.camera.bottom = -12;
            sun.shadow.camera.right = sun.shadow.camera.top = 12;
            scene.add(sun);

            const rimL = new THREE.SpotLight(0xff4d00, 60, 50, 0.45, 0.1);
            rimL.position.set(-10, 8, -5);
            scene.add(rimL);

            const rimR = new THREE.SpotLight(0xffb400, 30, 50, 0.45, 0.1);
            rimR.position.set(10, 8, -5);
            scene.add(rimR);
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ENVIRONMENT
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        function setupEnvironment() {
            // Ground
            const geo = new THREE.PlaneGeometry(80, 80, 40, 40);
            const mat = new THREE.MeshStandardMaterial({ color: 0x1a1008, roughness: 0.95, metalness: 0.0 });
            const ground = new THREE.Mesh(geo, mat);
            ground.rotation.x = -Math.PI / 2;
            ground.receiveShadow = true;
            scene.add(ground);

            // Grid
            const grid = new THREE.GridHelper(80, 60, 0xff4d00, 0x1a1008);
            grid.position.y = 0.01;
            grid.material.opacity = 0.15;
            grid.material.transparent = true;
            scene.add(grid);

            // Crowd torches (point lights in distance)
            const torchColors = [0xff6600, 0xffaa00, 0xff3300];
            for (let i = 0; i < 8; i++) {
                const angle = (i / 8) * Math.PI * 2;
                const pl = new THREE.PointLight(torchColors[i % 3], 5, 15);
                pl.position.set(Math.cos(angle) * 14, 3, Math.sin(angle) * 14);
                scene.add(pl);
            }
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           DUST PARTICLE SYSTEM
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        function setupDust() {
            dustPositions = new Float32Array(DUST_COUNT * 3);
            dustVelocities = [];
            dustLifetimes = new Float32Array(DUST_COUNT);

            for (let i = 0; i < DUST_COUNT; i++) {
                dustPositions[i * 3] = 9999; // park off-screen
                dustPositions[i * 3 + 1] = 0;
                dustPositions[i * 3 + 2] = 9999;
                dustVelocities.push(new THREE.Vector3());
                dustLifetimes[i] = 0;
            }

            dustGeo = new THREE.BufferGeometry();
            dustGeo.setAttribute('position', new THREE.BufferAttribute(dustPositions, 3));

            const mat = new THREE.PointsMaterial({
                color: 0xc8a060, size: 0.12, transparent: true, opacity: 0.7,
                depthWrite: false, sizeAttenuation: true
            });

            dustMesh = new THREE.Points(dustGeo, mat);
            scene.add(dustMesh);
        }

        function spawnDustBurst(origin, count = 60) {
            let spawned = 0;
            for (let i = 0; i < DUST_COUNT && spawned < count; i++) {
                if (dustLifetimes[i] <= 0) {
                    dustPositions[i * 3] = origin.x + (Math.random() - .5) * 1.2;
                    dustPositions[i * 3 + 1] = origin.y + Math.random() * 0.3;
                    dustPositions[i * 3 + 2] = origin.z + (Math.random() - .5) * 1.2;
                    dustVelocities[i].set(
                        (Math.random() - .5) * 2.5,
                        Math.random() * 2 + 0.5,
                        (Math.random() - .5) * 2.5
                    );
                    dustLifetimes[i] = 0.8 + Math.random() * 0.8;
                    spawned++;
                }
            }
            dustGeo.attributes.position.needsUpdate = true;
        }

        function updateDust(dt) {
            let changed = false;
            for (let i = 0; i < DUST_COUNT; i++) {
                if (dustLifetimes[i] > 0) {
                    dustLifetimes[i] -= dt;
                    dustPositions[i * 3] += dustVelocities[i].x * dt;
                    dustPositions[i * 3 + 1] += dustVelocities[i].y * dt;
                    dustPositions[i * 3 + 2] += dustVelocities[i].z * dt;
                    dustVelocities[i].y -= 3 * dt; // gravity
                    if (dustLifetimes[i] <= 0) {
                        dustPositions[i * 3] = dustPositions[i * 3 + 2] = 9999;
                    }
                    changed = true;
                }
            }
            if (changed) dustGeo.attributes.position.needsUpdate = true;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           LOAD BULL MODEL
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        function loadBull() {
            const loader = new GLTFLoader();
            const fill = document.getElementById('progress-fill');
            const txt = document.getElementById('loader-text');

            loader.load('./bull.glb',
                (gltf) => {
                    bullModel = gltf.scene;

                    // Fit to ground
                    const box = new THREE.Box3().setFromObject(bullModel);
                    const size = box.getSize(new THREE.Vector3());
                    const center = box.getCenter(new THREE.Vector3());

                    // Auto-scale: target ~3 units tall
                    const targetH = 3;
                    const scale = targetH / size.y;
                    bullModel.scale.setScalar(scale);

                    // Re-compute after scale
                    const box2 = new THREE.Box3().setFromObject(bullModel);
                    bullModel.position.y = -box2.min.y;
                    bullModel.position.x = 0;
                    bullModel.position.z = 0;
                    bullModel.rotation.y = Math.PI; // face camera

                    bullModel.traverse(c => {
                        if (c.isMesh) {
                            c.castShadow = c.receiveShadow = true;
                            if (c.material) { c.material.roughness = 0.65; c.material.metalness = 0.05; }
                        }
                    });

                    scene.add(bullModel);
                    bullStartPos = bullModel.position.clone();

                    // â”€â”€ Build invisible leg-bone proxies attached to bull â”€â”€
                    legBoneL = new THREE.Object3D();
                    legBoneR = new THREE.Object3D();
                    hoofBoneL = new THREE.Object3D();
                    hoofBoneR = new THREE.Object3D();

                    const bh = new THREE.Box3().setFromObject(bullModel).getSize(new THREE.Vector3());
                    const legOffsetX = bh.x * 0.22;
                    const legOffsetZ = bh.z * 0.38;
                    const legOffsetY = bh.y * 0.35;
                    const hoofDropY = bh.y * 0.35;

                    legBoneL.position.set(-legOffsetX, legOffsetY, legOffsetZ);
                    legBoneR.position.set(legOffsetX, legOffsetY, legOffsetZ);
                    hoofBoneL.position.set(0, -hoofDropY, 0);
                    hoofBoneR.position.set(0, -hoofDropY, 0);

                    legBoneL.add(hoofBoneL);
                    legBoneR.add(hoofBoneR);
                    bullModel.add(legBoneL);
                    bullModel.add(legBoneR);

                    // GLB animations
                    if (gltf.animations?.length) {
                        mixer = new THREE.AnimationMixer(bullModel);
                        const panel = document.getElementById('anim-panel');

                        gltf.animations.forEach((clip, i) => {
                            const action = mixer.clipAction(clip);
                            glbAnims.set(clip.name, action);

                            const btn = document.createElement('button');
                            btn.className = 'btn';
                            btn.innerHTML = `â—ˆ ${clip.name || 'Anim ' + (i + 1)}`;
                            btn.onclick = () => {
                                playGLBAnim(clip.name);
                                document.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
                                btn.classList.add('active');
                            };
                            panel.appendChild(btn);

                            if (i === 0) { btn.classList.add('active'); playGLBAnim(clip.name); }
                        });
                    } else {
                        startIdleBreathing();
                    }

                    document.getElementById('loader').classList.add('hidden');
                },
                (xhr) => {
                    const p = xhr.total ? (xhr.loaded / xhr.total) * 100 : 0;
                    fill.style.width = p + '%';
                    txt.innerText = `Loading: ${Math.round(p)}%`;
                },
                (err) => {
                    console.error(err);
                    txt.innerText = 'ERROR: bull.glb not found!';
                    txt.style.color = 'red';
                }
            );
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ANIMATION CONTROLS
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        let activeGLBAnim = null;
        function playGLBAnim(name) {
            const next = glbAnims.get(name);
            if (!next || activeGLBAnim === next) return;
            if (activeGLBAnim) activeGLBAnim.fadeOut(0.3);
            next.reset().fadeIn(0.3).play();
            activeGLBAnim = next;
        }

        let idleActive = false;
        function startIdleBreathing() { idleActive = true; }

        function applyIdleBreathing(t) {
            if (!idleActive || !bullModel || chargeState !== 'idle' || kickState !== 'idle') return;
            const s = 1 + Math.sin(t * 1.5) * 0.008;
            bullModel.scale.y = (3 / (new THREE.Box3().setFromObject(bullModel).getSize(new THREE.Vector3()).y || 1)) * s;
            bullModel.rotation.y = Math.PI + Math.sin(t * 0.4) * 0.04;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           âš¡ CHARGE SYSTEM
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        window.triggerCharge = function () {
            if (chargeState !== 'idle' || kickState !== 'idle' || !bullModel) return;
            document.getElementById('charge-btn').disabled = true;
            setStatus('WINDING UP...', true);
            chargeState = 'windup';
            chargeT = 0;
            chargeDir.set(0, 0, -1);
            bullStartPos = bullModel.position.clone();
            bullTargetPos = bullModel.position.clone().addScaledVector(chargeDir, 18);
            originalCamPos = camera.position.clone();
            originalCamTarget = controls.target.clone();
        };

        function updateCharge(dt) {
            if (!bullModel || chargeState === 'idle') return;
            chargeT += dt;

            if (chargeState === 'windup') {
                const t = Math.min(chargeT / 1.2, 1);
                bullModel.rotation.x = THREE.MathUtils.lerp(0, 0.35, easeInOut(t));
                bullModel.position.z = bullStartPos.z + Math.sin(t * Math.PI) * 0.3;
                if (Math.random() < 0.15) {
                    const hoofPos = bullModel.position.clone();
                    hoofPos.y = 0.05;
                    spawnDustBurst(hoofPos, 8);
                }
                if (chargeT >= 1.2) {
                    chargeState = 'sprint';
                    chargeT = 0;
                    setStatus('CHARGING!', true);
                    flashScreen(0.6, '#ff3e00');
                    showLabel('charge-label');
                    shakeIntensity = 0.25;
                }
            }
            else if (chargeState === 'sprint') {
                const t = Math.min(chargeT / 1.4, 1);
                const ease = easeIn(t);
                bullModel.position.lerpVectors(bullStartPos, bullTargetPos, ease);
                bullModel.rotation.x = THREE.MathUtils.lerp(0.35, -0.1, ease);
                bullModel.position.y = bullStartPos.y + Math.abs(Math.sin(chargeT * 14)) * 0.12;
                if (Math.random() < 0.6) {
                    const trail = bullModel.position.clone();
                    trail.y = 0.05;
                    spawnDustBurst(trail, 12);
                }
                const camPull = camera.position.clone();
                camPull.z = originalCamPos.z + ease * 3;
                camera.position.lerp(camPull, 0.08);
                shakeIntensity = 0.3 - ease * 0.2;
                if (chargeT >= 1.4) {
                    chargeState = 'brake';
                    chargeT = 0;
                    setStatus('IMPACT!', true);
                    flashScreen(1.0, '#ff3e00');
                    shakeIntensity = 0.5;
                    spawnDustBurst(bullModel.position, 120);
                }
            }
            else if (chargeState === 'brake') {
                const t = Math.min(chargeT / 0.8, 1);
                bullModel.rotation.x = THREE.MathUtils.lerp(-0.1, 0, easeOut(t));
                shakeIntensity = THREE.MathUtils.lerp(0.5, 0, t);
                if (chargeT >= 0.8) {
                    chargeState = 'reset';
                    chargeT = 0;
                    setStatus('RESETTING...', false);
                }
            }
            else if (chargeState === 'reset') {
                const t = Math.min(chargeT / 1.5, 1);
                bullModel.position.lerpVectors(bullModel.position.clone(), bullStartPos, easeInOut(t) * 0.08);
                bullModel.rotation.x = THREE.MathUtils.lerp(bullModel.rotation.x, 0, 0.1);
                camera.position.lerp(originalCamPos, 0.05);
                controls.target.lerp(originalCamTarget, 0.05);
                if (chargeT >= 1.5 && bullModel.position.distanceTo(bullStartPos) < 0.1) {
                    bullModel.position.copy(bullStartPos);
                    bullModel.rotation.x = 0;
                    chargeState = 'idle';
                    setStatus('IDLE', false);
                    document.getElementById('charge-btn').disabled = false;
                }
            }
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ¦µ BACK KICK SYSTEM
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        window.triggerKick = function () {
            if (kickState !== 'idle' || chargeState !== 'idle' || !bullModel) return;
            document.getElementById('kick-btn').disabled = true;
            setStatus('KICK WINDUP...', true);
            kickState = 'lean';
            kickT = 0;
            kickStartRotX = bullModel.rotation.x;
        };

        function updateKick(dt) {
            if (!bullModel || kickState === 'idle') return;
            kickT += dt;

            if (kickState === 'lean') {
                const t = Math.min(kickT / 0.5, 1);
                bullModel.rotation.x = THREE.MathUtils.lerp(kickStartRotX, -0.28, easeInOut(t));
                if (legBoneL) {
                    legBoneL.rotation.x = THREE.MathUtils.lerp(0, -0.5, easeInOut(t));
                    legBoneR.rotation.x = THREE.MathUtils.lerp(0, -0.5, easeInOut(t));
                }
                if (kickT >= 0.5) { kickState = 'lift'; kickT = 0; setStatus('LIFTING LEGS!', true); }
            }
            else if (kickState === 'lift') {
                const t = Math.min(kickT / 0.45, 1);
                if (legBoneL) {
                    legBoneL.rotation.x = THREE.MathUtils.lerp(-0.5, -1.4, easeOut(t));
                    legBoneR.rotation.x = THREE.MathUtils.lerp(-0.5, -1.4, easeOut(t));
                    if (hoofBoneL) {
                        hoofBoneL.rotation.x = THREE.MathUtils.lerp(0, 1.1, easeOut(t));
                        hoofBoneR.rotation.x = THREE.MathUtils.lerp(0, 1.1, easeOut(t));
                    }
                }
                if (kickT >= 0.45) { kickState = 'snap'; kickT = 0; setStatus('KICKING!', true); }
            }
            else if (kickState === 'snap') {
                const t = Math.min(kickT / 0.22, 1);
                if (legBoneL) {
                    legBoneL.rotation.x = THREE.MathUtils.lerp(-1.4, 0.9, easeIn(t));
                    legBoneR.rotation.x = THREE.MathUtils.lerp(-1.4, 0.9, easeIn(t));
                    if (hoofBoneL) {
                        hoofBoneL.rotation.x = THREE.MathUtils.lerp(1.1, -0.3, easeIn(t));
                        hoofBoneR.rotation.x = THREE.MathUtils.lerp(1.1, -0.3, easeIn(t));
                    }
                }
                bullModel.rotation.x = THREE.MathUtils.lerp(-0.28, 0.18, easeIn(t));
                if (kickT >= 0.12 && kickT < 0.14) {
                    flashScreen(0.7, '#7b00ff');
                    showLabel('kick-label');
                    shakeIntensity = 0.55;
                    if (hoofBoneL) {
                        const wL = new THREE.Vector3(); const wR = new THREE.Vector3();
                        hoofBoneL.getWorldPosition(wL); wL.y = 0.05;
                        hoofBoneR.getWorldPosition(wR); wR.y = 0.05;
                        spawnDustBurst(wL, 80); spawnDustBurst(wR, 80);
                        spawnHoofTrail(wL); spawnHoofTrail(wR);
                    }
                }
                if (kickT >= 0.22) { kickState = 'recoil'; kickT = 0; setStatus('RECOIL!', true); }
            }
            else if (kickState === 'recoil') {
                const t = Math.min(kickT / 0.5, 1);
                if (legBoneL) {
                    legBoneL.rotation.x = THREE.MathUtils.lerp(0.9, 0, easeOut(t));
                    legBoneR.rotation.x = THREE.MathUtils.lerp(0.9, 0, easeOut(t));
                    if (hoofBoneL) {
                        hoofBoneL.rotation.x = THREE.MathUtils.lerp(-0.3, 0, easeOut(t));
                        hoofBoneR.rotation.x = THREE.MathUtils.lerp(-0.3, 0, easeOut(t));
                    }
                }
                bullModel.rotation.x = THREE.MathUtils.lerp(0.18, kickStartRotX, easeOut(t));
                shakeIntensity = THREE.MathUtils.lerp(0.55, 0, t);
                if (kickT >= 0.5) { kickState = 'settle'; kickT = 0; setStatus('SETTLING...', false); }
            }
            else if (kickState === 'settle') {
                const t = Math.min(kickT / 0.6, 1);
                bullModel.rotation.x = THREE.MathUtils.lerp(bullModel.rotation.x, kickStartRotX, easeInOut(t) * 0.15);
                if (kickT >= 0.6) {
                    bullModel.rotation.x = kickStartRotX;
                    kickState = 'idle';
                    setStatus('IDLE', false);
                    document.getElementById('kick-btn').disabled = false;
                }
            }
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           VISUAL EFFECTS HELPERS
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        function applyCameraShake() {
            if (shakeIntensity <= 0) return;
            camera.position.x += (Math.random() - .5) * shakeIntensity * 0.15;
            camera.position.y += (Math.random() - .5) * shakeIntensity * 0.08;
            shakeIntensity *= 0.88;
            if (shakeIntensity < 0.005) shakeIntensity = 0;
        }

        function flashScreen(intensity, color) {
            const flash = document.getElementById('flash');
            flash.style.background = color || '#ff3e00';
            flash.style.opacity = intensity;
            setTimeout(() => { flash.style.opacity = 0; }, 90);
        }

        function showLabel(id) {
            const lbl = document.getElementById(id);
            lbl.style.opacity = 1;
            setTimeout(() => { lbl.style.opacity = 0; }, 700);
        }

        function spawnHoofTrail(worldPos) {
            const v = worldPos.clone().project(camera);
            const x = (v.x * 0.5 + 0.5) * innerWidth;
            const y = (-v.y * 0.5 + 0.5) * innerHeight;
            for (let i = 0; i < 6; i++) {
                const el = document.createElement('div');
                el.className = 'hoof-trail';
                el.style.left = (x + (Math.random() - .5) * 60) + 'px';
                el.style.top = (y + (Math.random() - .5) * 60) + 'px';
                document.getElementById('scene-container').appendChild(el);
                setTimeout(() => el.remove(), 600);
            }
        }

        function setStatus(text, active) {
            document.getElementById('status-text').innerText = text;
            const badge = document.getElementById('status-badge');
            active ? badge.classList.add('charging') : badge.classList.remove('charging');
        }

        const easeIn = t => t * t * t;
        const easeOut = t => 1 - Math.pow(1 - t, 3);
        const easeInOut = t => t < .5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 3) / 2;

        function animate() {
            requestAnimationFrame(animate);
            const dt = Math.min(clock.getDelta(), 0.05);
            const t = clock.elapsedTime;
            if (mixer) mixer.update(dt);
            controls.update();
            updateDust(dt);
            updateCharge(dt);
            updateKick(dt);
            applyCameraShake();
            applyIdleBreathing(t);
            renderer.render(scene, camera);
        }
    </script>
</body>

</html>