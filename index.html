<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mersal Bull | Jallikattu Arena</title>
    <style>
        :root {
            --primary: #ff3e00;
            --secondary: #ffb400;
            --bg: #0a0a0a;
            --glass: rgba(20, 20, 20, 0.85);
        }

        *,
        *::before,
        *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body,
        html {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: var(--bg);
            color: #fff;
            font-family: 'Outfit', -apple-system, sans-serif;
        }

        #scene-container {
            width: 100%;
            height: 100%;
            position: relative;
        }

        /* â”€â”€ VIGNETTE â”€â”€ */
        .vignette {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 5;
            background: radial-gradient(circle, transparent 45%, rgba(0, 0, 0, .85) 160%);
        }

        /* â”€â”€ FLASH OVERLAY â”€â”€ */
        #flash {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 200;
            background: #ff3e00;
            opacity: 0;
            transition: opacity 0.05s;
        }

        /* â”€â”€ HUD â”€â”€ */
        .hud {
            position: absolute;
            inset: 0;
            z-index: 100;
            pointer-events: none;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .title-group {
            border-left: 4px solid var(--primary);
            padding-left: 1.2rem;
        }

        h1 {
            font-size: 2.4rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 2px;
            background: linear-gradient(45deg, #fff, var(--secondary));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .subtitle {
            font-size: .8rem;
            color: var(--secondary);
            font-weight: 600;
            letter-spacing: 4px;
            text-transform: uppercase;
            margin-top: .2rem;
        }

        /* â”€â”€ STATUS BADGE â”€â”€ */
        #status-badge {
            display: inline-flex;
            align-items: center;
            gap: .5rem;
            background: var(--glass);
            border: 1px solid rgba(255, 255, 255, .1);
            backdrop-filter: blur(12px);
            border-radius: 30px;
            padding: .5rem 1.2rem;
            font-size: .8rem;
            font-weight: 600;
            letter-spacing: 1px;
            text-transform: uppercase;
            transition: all .3s ease;
        }

        #status-badge .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4caf50;
            box-shadow: 0 0 8px #4caf50;
            animation: pulse-dot 1.5s ease-in-out infinite;
        }

        @keyframes pulse-dot {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: .3;
            }
        }

        #status-badge.active {
            background: rgba(255, 62, 0, .3);
            border-color: var(--primary);
        }

        #status-badge.active .dot {
            background: var(--primary);
            box-shadow: 0 0 12px var(--primary);
        }

        /* â”€â”€ FOOTER â”€â”€ */
        .footer {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            gap: 1rem;
        }

        /* â”€â”€ BUTTON PANEL â”€â”€ */
        .btn-panel {
            pointer-events: all;
            display: flex;
            gap: .8rem;
            flex-wrap: wrap;
        }

        .btn {
            background: var(--glass);
            border: 1px solid rgba(255, 255, 255, .15);
            color: #fff;
            padding: .75rem 1.4rem;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 700;
            font-size: .8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all .25s cubic-bezier(.4, 0, .2, 1);
            display: flex;
            align-items: center;
            gap: .5rem;
            backdrop-filter: blur(10px);
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 24px rgba(255, 62, 0, .3);
            background: var(--primary);
            border-color: var(--primary);
        }

        .btn.active {
            background: var(--primary);
            border-color: var(--primary);
            box-shadow: 0 0 20px rgba(255, 62, 0, .5);
        }

        /* Special action buttons */
        #charge-btn {
            background: linear-gradient(135deg, #ff3e00, #ff8c00);
            border-color: #ff8c00;
            animation: pulse 2s ease-in-out infinite;
        }

        #kick-btn {
            background: linear-gradient(135deg, #7b00ff, #c800ff);
            border-color: #c800ff;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                box-shadow: 0 0 16px rgba(255, 62, 0, .4);
            }

            50% {
                box-shadow: 0 0 32px rgba(255, 62, 0, .8);
            }
        }

        /* â”€â”€ CONTROLS HINT â”€â”€ */
        .controls-hint {
            background: var(--glass);
            padding: .9rem 1.3rem;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, .08);
            font-size: .75rem;
            color: #777;
            line-height: 1.7;
        }

        .controls-hint strong {
            color: var(--secondary);
            display: block;
            margin-bottom: .2rem;
        }

        /* â”€â”€ LOADER â”€â”€ */
        .loader-overlay {
            position: absolute;
            inset: 0;
            background: var(--bg);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: opacity .8s ease;
        }

        .loader-spinner {
            width: 56px;
            height: 56px;
            border: 4px solid rgba(255, 62, 0, .1);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1.5rem;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .progress-bar {
            width: 200px;
            height: 2px;
            background: rgba(255, 255, 255, .1);
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            width: 0%;
            height: 100%;
            background: var(--primary);
            transition: width .3s ease;
        }

        .hidden {
            opacity: 0 !important;
            pointer-events: none !important;
        }

        /* â”€â”€ CINEMATIC LABELS â”€â”€ */
        .cin-label {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            font-size: 5rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 8px;
            opacity: 0;
            pointer-events: none;
            z-index: 300;
            transition: opacity .15s;
        }

        #charge-label {
            top: 48%;
            color: var(--primary);
            text-shadow: 0 0 40px rgba(255, 62, 0, .9);
        }

        #kick-label {
            top: 40%;
            color: #c800ff;
            text-shadow: 0 0 40px rgba(200, 0, 255, .9);
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
</head>

<body>
    <div id="scene-container">
        <div class="vignette"></div>
        <div id="flash"></div>

        <div class="cin-label" id="charge-label">âš¡ CHARGE!</div>
        <div class="cin-label" id="kick-label">ðŸ’¥ KICK!</div>

        <div class="hud">
            <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                <div class="title-group">
                    <h1>Mersal Bull</h1>
                    <div class="subtitle">Jallikattu Arena Simulator</div>
                </div>
                <div id="status-badge"><span class="dot"></span><span id="status-text">READY</span></div>
            </div>

            <div class="footer">
                <div class="btn-panel">
                    <button class="btn" id="charge-btn" onclick="triggerCharge()">âš¡ Charge</button>
                    <button class="btn" id="kick-btn" onclick="triggerKick()">ðŸ¦µ Back Kick</button>
                    <div id="bull-anim-row" style="display:flex; gap:.8rem;"></div>
                </div>
                <div class="controls-hint">
                    <strong>VIEWER CONTROLS</strong>
                    Rotate: Left Click + Drag<br>
                    Zoom: Scroll Wheel<br>
                    Pan: Right Click + Drag
                </div>
            </div>
        </div>

        <div class="loader-overlay" id="loader">
            <div class="loader-spinner"></div>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <div id="loader-text" style="margin-top:1rem;color:var(--secondary);font-weight:600;">Loading Bull...</div>
        </div>
    </div>

    <script type="importmap">
{
    "imports": {
        "three": "https://unpkg.com/three@0.161.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.161.0/examples/jsm/"
    }
}
</script>
    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        let scene, camera, renderer, controls, clock;
        let bullModel, mixer;
        const glbAnims = new Map();

        let shakeIntensity = 0;
        let dustPositions, dustVelocities, dustLifetimes, dustGeo, dustMesh;
        const DUST_COUNT = 300;

        let origCamPos, origCamTarget;

        // Bull States
        let chargeState = 'idle'; // idle|windup|sprint|brake|reset
        let chargeT = 0, bullStartPos, bullTargetPos;
        let kickState = 'idle';   // idle|lean|lift|snap|recoil|settle
        let kickT = 0, kickStartRotX = 0;
        let legBoneL, legBoneR, hoofBoneL, hoofBoneR;

        init();

        async function init() {
            clock = new THREE.Clock();
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0a0a0a);
            scene.fog = new THREE.FogExp2(0x0a0a0a, 0.04);

            camera = new THREE.PerspectiveCamera(42, innerWidth / innerHeight, 0.1, 500);
            camera.position.set(0, 2.5, 10);
            origCamPos = camera.position.clone();
            origCamTarget = new THREE.Vector3(0, 1.5, 0);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(innerWidth, innerHeight);
            renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.shadowMap.enabled = true;
            document.getElementById('scene-container').appendChild(renderer.domElement);

            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.target.copy(origCamTarget);

            setupLights();
            setupEnvironment();
            setupDust();

            const loader = new GLTFLoader();
            const fill = document.getElementById('progress-fill');
            loader.load('./bull.glb', (gltf) => {
                bullModel = gltf.scene;

                // Fit to ground and scale
                const box = new THREE.Box3().setFromObject(bullModel);
                const size = box.getSize(new THREE.Vector3());
                bullModel.scale.setScalar(3.2 / size.y);
                const box2 = new THREE.Box3().setFromObject(bullModel);
                bullModel.position.y = -box2.min.y;
                bullModel.position.x = 0;
                bullModel.position.z = 0;
                bullModel.rotation.y = Math.PI;

                bullModel.traverse(c => { if (c.isMesh) c.castShadow = c.receiveShadow = true; });
                scene.add(bullModel);
                bullStartPos = bullModel.position.clone();

                // Leg bones for kick dust
                legBoneL = new THREE.Object3D(); legBoneR = new THREE.Object3D();
                hoofBoneL = new THREE.Object3D(); hoofBoneR = new THREE.Object3D();
                const b = new THREE.Box3().setFromObject(bullModel).getSize(new THREE.Vector3());
                legBoneL.position.set(-b.x * .22, b.y * .35, b.z * .38);
                legBoneR.position.set(b.x * .22, b.y * .35, b.z * .38);
                hoofBoneL.position.set(0, -b.y * .35, 0);
                hoofBoneR.position.set(0, -b.y * .35, 0);
                legBoneL.add(hoofBoneL); legBoneR.add(hoofBoneR);
                bullModel.add(legBoneL); bullModel.add(legBoneR);

                if (gltf.animations?.length) {
                    mixer = new THREE.AnimationMixer(bullModel);
                    const row = document.getElementById('bull-anim-row');
                    gltf.animations.forEach((clip, i) => {
                        const action = mixer.clipAction(clip);
                        glbAnims.set(clip.name, action);
                        const btn = document.createElement('button');
                        btn.className = 'btn';
                        btn.innerHTML = `â—ˆ ${clip.name || 'Anim ' + (i + 1)}`;
                        btn.onclick = () => {
                            playGLBAnim(clip.name);
                            row.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
                            btn.classList.add('active');
                        };
                        row.appendChild(btn);
                        if (i === 0) { btn.classList.add('active'); playGLBAnim(clip.name); }
                    });
                }

                setTimeout(() => document.getElementById('loader').classList.add('hidden'), 500);
            }, (xhr) => {
                fill.style.width = (xhr.loaded / xhr.total * 100) + '%';
            });

            window.addEventListener('resize', () => {
                camera.aspect = innerWidth / innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(innerWidth, innerHeight);
            });

            animate();
        }

        function setupLights() {
            scene.add(new THREE.AmbientLight(0xffffff, 0.3));
            const sun = new THREE.DirectionalLight(0xfff5e0, 2);
            sun.position.set(10, 20, 10);
            sun.castShadow = true;
            scene.add(sun);
            const rim = new THREE.SpotLight(0xff4d00, 50, 40, 0.5, 0.1);
            rim.position.set(-10, 10, -5);
            scene.add(rim);
        }

        function setupEnvironment() {
            const ground = new THREE.Mesh(new THREE.PlaneGeometry(80, 80), new THREE.MeshStandardMaterial({ color: 0x1a1008 }));
            ground.rotation.x = -Math.PI / 2;
            ground.receiveShadow = true;
            scene.add(ground);
            const grid = new THREE.GridHelper(80, 60, 0xff4d00, 0x1a1008);
            grid.material.opacity = 0.1; grid.material.transparent = true;
            scene.add(grid);
        }

        function setupDust() {
            dustPositions = new Float32Array(DUST_COUNT * 3);
            dustVelocities = [];
            dustLifetimes = new Float32Array(DUST_COUNT);
            for (let i = 0; i < DUST_COUNT; i++) {
                dustPositions[i * 3] = dustPositions[i * 3 + 2] = 9999;
                dustVelocities.push(new THREE.Vector3());
            }
            dustGeo = new THREE.BufferGeometry().setAttribute('position', new THREE.BufferAttribute(dustPositions, 3));
            dustMesh = new THREE.Points(dustGeo, new THREE.PointsMaterial({ color: 0xc8a060, size: 0.1, transparent: true, opacity: 0.6 }));
            scene.add(dustMesh);
        }

        function spawnDust(origin, count = 40) {
            let n = 0;
            for (let i = 0; i < DUST_COUNT && n < count; i++) {
                if (dustLifetimes[i] <= 0) {
                    dustPositions[i * 3] = origin.x + (Math.random() - .5);
                    dustPositions[i * 3 + 2] = origin.z + (Math.random() - .5);
                    dustVelocities[i].set((Math.random() - .5) * 2, Math.random() * 2 + .5, (Math.random() - .5) * 2);
                    dustLifetimes[i] = .8 + Math.random();
                    n++;
                }
            }
        }

        function updateDust(dt) {
            let changed = false;
            for (let i = 0; i < DUST_COUNT; i++) {
                if (dustLifetimes[i] > 0) {
                    dustLifetimes[i] -= dt;
                    dustPositions[i * 3] += dustVelocities[i].x * dt;
                    dustPositions[i * 3 + 1] += dustVelocities[i].y * dt;
                    dustPositions[i * 3 + 2] += dustVelocities[i].z * dt;
                    dustVelocities[i].y -= 3 * dt;
                    if (dustLifetimes[i] <= 0) dustPositions[i * 3] = dustPositions[i * 3 + 2] = 9999;
                    changed = true;
                }
            }
            if (changed) dustGeo.attributes.position.needsUpdate = true;
        }

        function flash(intensity, color = '#ff3e00') {
            const f = document.getElementById('flash');
            f.style.background = color; f.style.opacity = intensity;
            setTimeout(() => f.style.opacity = 0, 80);
        }

        function showLabel(id) {
            const l = document.getElementById(id);
            l.style.opacity = 1; setTimeout(() => l.style.opacity = 0, 800);
        }

        function setStatus(t, a) {
            document.getElementById('status-text').innerText = t;
            const b = document.getElementById('status-badge');
            a ? b.classList.add('active') : b.classList.remove('active');
        }

        let activeAnim = null;
        function playGLBAnim(name) {
            const next = glbAnims.get(name);
            if (!next || activeAnim === next) return;
            if (activeAnim) activeAnim.fadeOut(0.3);
            next.reset().fadeIn(0.3).play();
            activeAnim = next;
        }

        window.triggerCharge = function () {
            if (chargeState !== 'idle' || kickState !== 'idle' || !bullModel) return;
            chargeState = 'windup'; chargeT = 0;
            bullStartPos = bullModel.position.clone();
            bullTargetPos = bullModel.position.clone().add(new THREE.Vector3(0, 0, -18));
            setStatus('WINDING UP...', true);
            origCamPos = camera.position.clone();
            origCamTarget = controls.target.clone();
        };

        function updateCharge(dt) {
            if (!bullModel || chargeState === 'idle') return;
            chargeT += dt;
            if (chargeState === 'windup') {
                bullModel.rotation.x = THREE.MathUtils.lerp(0, .3, chargeT / 1.2);
                if (chargeT >= 1.2) { chargeState = 'sprint'; chargeT = 0; flash(.6); showLabel('charge-label'); shakeIntensity = .2; setStatus('CHARGING!', true); }
            } else if (chargeState === 'sprint') {
                const ease = easeIn(chargeT / 1.4);
                bullModel.position.lerpVectors(bullStartPos, bullTargetPos, ease);
                bullModel.position.y = bullStartPos.y + Math.abs(Math.sin(chargeT * 15)) * .1;
                if (Math.random() < .6) spawnDust(bullModel.position, 10);
                if (chargeT >= 1.4) { chargeState = 'brake'; chargeT = 0; flash(1); shakeIntensity = .5; spawnDust(bullModel.position, 100); setStatus('IMPACT!', true); }
            } else if (chargeState === 'brake') {
                bullModel.rotation.x = THREE.MathUtils.lerp(.3, 0, chargeT / .8);
                if (chargeT >= .8) { chargeState = 'reset'; chargeT = 0; setStatus('RESETTING...', false); }
            } else if (chargeState === 'reset') {
                bullModel.position.lerp(bullStartPos, .05);
                camera.position.lerp(origCamPos, .05);
                if (chargeT >= 2 && bullModel.position.distanceTo(bullStartPos) < .1) {
                    bullModel.position.copy(bullStartPos); bullModel.rotation.x = 0;
                    chargeState = 'idle'; setStatus('READY', false);
                }
            }
        }

        window.triggerKick = function () {
            if (kickState !== 'idle' || chargeState !== 'idle' || !bullModel) return;
            kickState = 'lean'; kickT = 0; setStatus('KICK WINDUP...', true);
        }

        function updateKick(dt) {
            if (!bullModel || kickState === 'idle') return;
            kickT += dt;
            if (kickState === 'lean') {
                bullModel.rotation.x = THREE.MathUtils.lerp(0, -.3, kickT / .5);
                if (kickT >= .5) { kickState = 'lift'; kickT = 0; }
            } else if (kickState === 'lift') {
                if (legBoneL) { legBoneL.rotation.x = THREE.MathUtils.lerp(0, -1.4, kickT / .4); legBoneR.rotation.x = legBoneL.rotation.x; }
                if (kickT >= .4) { kickState = 'snap'; kickT = 0; }
            } else if (kickState === 'snap') {
                if (legBoneL) { legBoneL.rotation.x = THREE.MathUtils.lerp(-1.4, .9, kickT / .2); legBoneR.rotation.x = legBoneL.rotation.x; }
                if (kickT >= .1 && kickT < .12) {
                    flash(.7, '#7b00ff'); showLabel('kick-label'); shakeIntensity = .6;
                    const wL = new THREE.Vector3(); hoofBoneL.getWorldPosition(wL); spawnDust(wL, 80);
                }
                if (kickT >= .2) { kickState = 'recoil'; kickT = 0; }
            } else if (kickState === 'recoil') {
                if (legBoneL) { legBoneL.rotation.x = THREE.MathUtils.lerp(.9, 0, kickT / .5); legBoneR.rotation.x = legBoneL.rotation.x; }
                bullModel.rotation.x = THREE.MathUtils.lerp(-.3, 0, kickT / .5);
                if (kickT >= .5) { kickState = 'idle'; setStatus('READY', false); }
            }
        }

        const easeIn = t => t * t * t;
        function animate() {
            requestAnimationFrame(animate);
            const dt = Math.min(clock.getDelta(), .05);
            if (mixer) mixer.update(dt);
            controls.update();
            updateDust(dt);
            updateCharge(dt);
            updateKick(dt);
            if (shakeIntensity > 0) {
                camera.position.x += (Math.random() - .5) * shakeIntensity;
                shakeIntensity *= .9;
            }
            renderer.render(scene, camera);
        }
    </script>
</body>

</html>